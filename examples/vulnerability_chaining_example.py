#!/usr/bin/env python3
"""
Example: Vulnerability Chaining Analysis
Demonstrates how to use the vulnerability chaining system
"""

import json
import sys
from pathlib import Path

# Add scripts to path
sys.path.insert(0, str(Path(__file__).parent.parent / "scripts"))

from vulnerability_chaining_engine import VulnerabilityChainer
from chain_visualizer import ChainVisualizer


def example_1_simple_chain():
    """Example 1: Simple 2-step attack chain"""
    print("=" * 80)
    print("Example 1: Simple Attack Chain (IDOR â†’ Privilege Escalation)")
    print("=" * 80)
    
    findings = [
        {
            'id': 'idor-001',
            'category': 'IDOR',
            'severity': 'medium',
            'title': 'Insecure Direct Object Reference',
            'description': 'User can access other users\' profiles by changing ID parameter',
            'path': '/api/routes/users.py',
            'line': 42,
            'cwe': 'CWE-639',
            'exploitability': 'trivial',
            'reachability': 'yes',
        },
        {
            'id': 'auth-001',
            'category': 'PRIVILEGE_ESCALATION',
            'severity': 'high',
            'title': 'Missing Admin Role Check',
            'description': 'No validation for admin-only operations',
            'path': '/api/middleware/auth.py',
            'line': 120,
            'cwe': 'CWE-269',
            'exploitability': 'moderate',
            'reachability': 'yes',
        },
    ]
    
    chainer = VulnerabilityChainer(min_risk_threshold=0.0)
    result = chainer.analyze(findings)
    
    visualizer = ChainVisualizer()
    visualizer.print_console_report(result, max_chains=1)


def example_2_account_takeover():
    """Example 2: Complete account takeover chain"""
    print("\n" + "=" * 80)
    print("Example 2: Account Takeover Chain (XSS â†’ CSRF â†’ Session Hijacking)")
    print("=" * 80)
    
    findings = [
        {
            'id': 'xss-001',
            'category': 'XSS',
            'severity': 'medium',
            'title': 'Stored Cross-Site Scripting',
            'description': 'Unescaped user input in profile bio',
            'path': '/app/templates/profile.html',
            'line': 45,
            'cwe': 'CWE-79',
            'exploitability': 'trivial',
            'reachability': 'yes',
        },
        {
            'id': 'csrf-001',
            'category': 'CSRF',
            'severity': 'low',
            'title': 'Missing CSRF Token',
            'description': 'No CSRF protection on state-changing operations',
            'path': '/app/views.py',
            'line': 200,
            'cwe': 'CWE-352',
            'exploitability': 'moderate',
            'reachability': 'yes',
        },
        {
            'id': 'session-001',
            'category': 'SESSION_HIJACKING',
            'severity': 'high',
            'title': 'Session Token in URL',
            'description': 'Session token exposed in URL parameter',
            'path': '/app/auth.py',
            'line': 88,
            'cwe': 'CWE-598',
            'exploitability': 'moderate',
            'reachability': 'yes',
        },
    ]
    
    chainer = VulnerabilityChainer(min_risk_threshold=0.0)
    result = chainer.analyze(findings)
    
    visualizer = ChainVisualizer()
    visualizer.print_console_report(result, max_chains=2)


def example_3_data_breach():
    """Example 3: Data breach scenario"""
    print("\n" + "=" * 80)
    print("Example 3: Data Breach Chain (SQLi â†’ Database Access â†’ Data Exfiltration)")
    print("=" * 80)
    
    findings = [
        {
            'id': 'sqli-001',
            'category': 'SQL_INJECTION',
            'severity': 'critical',
            'title': 'SQL Injection in Search',
            'description': 'Unparameterized query with user input',
            'path': '/api/search.py',
            'line': 67,
            'cwe': 'CWE-89',
            'exploitability': 'trivial',
            'reachability': 'yes',
        },
        {
            'id': 'db-001',
            'category': 'DATABASE_ACCESS',
            'severity': 'high',
            'title': 'Unrestricted Database Access',
            'description': 'Database user has excessive privileges',
            'path': '/config/database.py',
            'line': 15,
            'cwe': 'CWE-250',
            'exploitability': 'moderate',
            'reachability': 'yes',
        },
        {
            'id': 'data-001',
            'category': 'DATA_EXFILTRATION',
            'severity': 'critical',
            'title': 'Sensitive Data Exposure',
            'description': 'PII accessible without encryption',
            'path': '/api/admin.py',
            'line': 200,
            'cwe': 'CWE-359',
            'exploitability': 'moderate',
            'reachability': 'partial',
        },
    ]
    
    chainer = VulnerabilityChainer(min_risk_threshold=0.0)
    result = chainer.analyze(findings)
    
    visualizer = ChainVisualizer()
    visualizer.print_console_report(result, max_chains=2)
    
    # Save markdown report
    visualizer.generate_markdown_report(result, "/tmp/chain-report.md")
    print(f"\nâœ… Markdown report saved to: /tmp/chain-report.md")


def example_4_rce_chain():
    """Example 4: Remote code execution chain"""
    print("\n" + "=" * 80)
    print("Example 4: RCE Chain (SSRF â†’ Path Traversal â†’ Command Injection)")
    print("=" * 80)
    
    findings = [
        {
            'id': 'ssrf-001',
            'category': 'SSRF',
            'severity': 'high',
            'title': 'Server-Side Request Forgery',
            'description': 'Unvalidated URL in image proxy',
            'path': '/api/proxy.py',
            'line': 34,
            'cwe': 'CWE-918',
            'exploitability': 'moderate',
            'reachability': 'yes',
        },
        {
            'id': 'path-001',
            'category': 'PATH_TRAVERSAL',
            'severity': 'medium',
            'title': 'Directory Traversal',
            'description': 'Path traversal in file download',
            'path': '/api/files.py',
            'line': 78,
            'cwe': 'CWE-22',
            'exploitability': 'trivial',
            'reachability': 'yes',
        },
        {
            'id': 'cmd-001',
            'category': 'COMMAND_INJECTION',
            'severity': 'critical',
            'title': 'OS Command Injection',
            'description': 'Unsanitized input in subprocess call',
            'path': '/api/processor.py',
            'line': 145,
            'cwe': 'CWE-78',
            'exploitability': 'moderate',
            'reachability': 'partial',
        },
    ]
    
    chainer = VulnerabilityChainer(min_risk_threshold=0.0)
    result = chainer.analyze(findings)
    
    visualizer = ChainVisualizer()
    visualizer.print_console_report(result, max_chains=2)


def example_5_load_from_file():
    """Example 5: Load findings from file"""
    print("\n" + "=" * 80)
    print("Example 5: Load Findings from Scan Results")
    print("=" * 80)
    
    # This example shows how to use real scan results
    print("\nTo use with real scan results:")
    print("  python vulnerability_chaining_engine.py \\")
    print("    --input /path/to/scan-results.json \\")
    print("    --output /path/to/chains.json")
    print("\nThen visualize:")
    print("  python chain_visualizer.py \\")
    print("    --input /path/to/chains.json \\")
    print("    --output-md chain-report.md \\")
    print("    --console")


def main():
    """Run all examples"""
    print("\nðŸ”— Vulnerability Chaining Examples")
    print("=" * 80)
    print("\nThese examples demonstrate how vulnerability chaining")
    print("amplifies risk by showing multi-step attack scenarios.\n")
    
    example_1_simple_chain()
    example_2_account_takeover()
    example_3_data_breach()
    example_4_rce_chain()
    example_5_load_from_file()
    
    print("\n" + "=" * 80)
    print("âœ… All examples complete!")
    print("=" * 80)


if __name__ == "__main__":
    main()
