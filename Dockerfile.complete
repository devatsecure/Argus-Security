FROM python:3.11-slim-bookworm

LABEL org.opencontainers.image.title="Argus Security - Complete Scanner"
LABEL org.opencontainers.image.description="Enterprise AI Security Platform with 6-phase pipeline: SAST, CVE scanning, IaC security, secrets detection, AI triage, and sandbox validation"
LABEL org.opencontainers.image.vendor="Argus Security"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    wget \
    ca-certificates \
    gnupg \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install Trivy
RUN wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor -o /usr/share/keyrings/trivy.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb generic main" | tee /etc/apt/sources.list.d/trivy.list && \
    apt-get update && \
    apt-get install -y trivy && \
    rm -rf /var/lib/apt/lists/*

# Install TruffleHog
RUN curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

# Install Gitleaks
RUN wget -qO - https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz | tar -xzC /usr/local/bin

# Install unzip (required for Nuclei)
RUN apt-get update && apt-get install -y --no-install-recommends \
    unzip \
    openjdk-17-jre-headless \
    && rm -rf /var/lib/apt/lists/*

# Install Nuclei (for DAST)
RUN wget -q https://github.com/projectdiscovery/nuclei/releases/download/v3.1.0/nuclei_3.1.0_linux_amd64.zip -O /tmp/nuclei.zip && \
    unzip /tmp/nuclei.zip -d /usr/local/bin && \
    rm /tmp/nuclei.zip && \
    chmod +x /usr/local/bin/nuclei && \
    nuclei -update-templates || true

# Install OWASP ZAP (for DAST)
RUN wget -q https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/ZAP_2.14.0_Linux.tar.gz -O /tmp/zap.tar.gz && \
    tar -xzf /tmp/zap.tar.gz -C /opt && \
    rm /tmp/zap.tar.gz && \
    ln -s /opt/ZAP_2.14.0/zap.sh /usr/local/bin/zap.sh || true

# Set Python environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONPATH=/app

WORKDIR /app

# Copy Python dependencies
COPY requirements.txt .

# Install Python packages including all scanners
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir \
    semgrep \
    checkov \
    pytm \
    anthropic \
    openai \
    tenacity \
    pyyaml \
    requests \
    rich \
    networkx

# Copy application code
COPY scripts/ ./scripts/
COPY policy/ ./policy/
COPY profiles/ ./profiles/
COPY schemas/ ./schemas/
COPY config/ ./config/

# Create non-root user for security (matches base Dockerfile)
RUN groupadd -r agentuser && useradd -r -g agentuser -u 1000 agentuser

# Create workspace and output directories with proper permissions
RUN mkdir -p /workspace /output && \
    chmod 755 /workspace /output && \
    chown -R agentuser:agentuser /app /workspace /output

# Initialize Trivy database
RUN trivy image --download-db-only || true

WORKDIR /workspace

# Switch to non-root user for security
USER agentuser

# Set entrypoint to run_ai_audit.py for complete 6-phase scanning with Phase 2.7 support
ENTRYPOINT ["python", "/app/scripts/run_ai_audit.py"]

# Default: show help
CMD ["--help"]
